---
import { getNavigation } from "../data/navigation";
import { Icon } from "astro-icon/components";
import type { Lang } from "../data/i18n";

interface Props {
    lang?: string;
    alternates?: { hreflang: string; href: string }[];
}

const { lang = "de", alternates } = Astro.props;
const currentPath = Astro.url.pathname;
const isDev = import.meta.env.DEV;
const visibleNav = getNavigation(lang as Lang).filter((item) => !item.devOnly || isDev);

// Language switcher data
const hasTranslation = alternates && alternates.length > 0;
const langLinks = hasTranslation
    ? Object.fromEntries(alternates.map((a) => [a.hreflang, new URL(a.href).pathname]))
    : null;
---

<header class="fixed top-0 left-0 right-0 z-40 bg-white/80 dark:bg-gray-950/80 backdrop-blur-md border-b border-gray-200/60 dark:border-gray-800/60">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex items-center justify-between h-16">
            <!-- Logo / Brand -->
            <a href="/" class="text-lg font-semibold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"> Tristan Germer </a>

            <!-- Desktop Navigation + Utils + Mobile hamburger -->
            <div class="flex items-center gap-1">
                <ul class="hidden md:flex items-center gap-1">
                    {
                        visibleNav.map((item) => {
                            const isActive = currentPath.startsWith(item.link);
                            return (
                                <li>
                                    <a href={item.link} class={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${isActive ? "bg-blue-50 dark:bg-blue-950 text-blue-700 dark:text-blue-300" : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-900 hover:text-gray-900 dark:hover:text-white"}`} aria-current={isActive ? "page" : undefined}>
                                        {item.name}
                                    </a>
                                </li>
                            );
                        })
                    }
                </ul>

                <!-- Separator: nav | utils (desktop only) -->
                <div class="hidden md:block w-px h-5 bg-gray-300 dark:bg-gray-700 mx-1" aria-hidden="true"></div>

                <!-- Language switcher -->
                <div data-lang-switcher class="flex items-center text-xs font-medium" aria-label="Sprache wechseln">
                    {hasTranslation ? (
                        lang === "de" ? (
                            <>
                                <span class="px-1 py-0.5 font-bold text-blue-700 dark:text-blue-300">DE</span>
                                <span class="text-gray-300 dark:text-gray-600 mx-0.5">|</span>
                                <a href={langLinks?.en} class="px-1 py-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer">EN</a>
                            </>
                        ) : (
                            <>
                                <a href={langLinks?.de} class="px-1 py-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer">DE</a>
                                <span class="text-gray-300 dark:text-gray-600 mx-0.5">|</span>
                                <span class="px-1 py-0.5 font-bold text-blue-700 dark:text-blue-300">EN</span>
                            </>
                        )
                    ) : lang === "de" ? (
                        <>
                            <span class="px-1 py-0.5 font-bold text-blue-700 dark:text-blue-300">DE</span>
                            <span class="text-gray-300 dark:text-gray-600 mx-0.5">|</span>
                            <span class="px-1 py-0.5 text-gray-300 dark:text-gray-700 cursor-not-allowed" title="Not available in English">EN</span>
                        </>
                    ) : (
                        <>
                            <span class="px-1 py-0.5 text-gray-300 dark:text-gray-700 cursor-not-allowed" title="Nicht auf Deutsch verfügbar">DE</span>
                            <span class="text-gray-300 dark:text-gray-600 mx-0.5">|</span>
                            <span class="px-1 py-0.5 font-bold text-blue-700 dark:text-blue-300">EN</span>
                        </>
                    )}
                </div>

                <button id="theme-toggle" class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors cursor-pointer" aria-label="Farbschema wechseln">
                    <Icon name="tabler:moon" id="theme-icon-moon" class="h-5 w-5 text-blue-700 dark:text-blue-400" />
                    <Icon name="tabler:sun" id="theme-icon-sun" class="h-5 w-5 hidden text-yellow-300 dark:text-yellow-300" />
                </button>

                <!-- Separator: utils | hamburger (mobile only) -->
                <div class="md:hidden w-px h-5 bg-gray-300 dark:bg-gray-700 mx-1" aria-hidden="true"></div>

                <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-900 cursor-pointer" aria-label="Menü öffnen" aria-expanded="false" aria-controls="mobile-menu">
                    <Icon name="tabler:menu-2" id="hamburger-icon" class="h-5 w-5" />
                    <Icon name="tabler:x" id="close-icon" class="h-5 w-5 hidden" />
                </button>
            </div>
        </nav>

        <!-- Mobile menu -->
        <div id="mobile-menu" class="hidden md:hidden pb-4">
            <ul class="flex flex-col gap-1">
                {
                    visibleNav.map((item) => {
                        const isActive = currentPath.startsWith(item.link);
                        return (
                            <li>
                                <a href={item.link} class={`block px-3 py-2 rounded-lg text-sm font-medium transition-colors ${isActive ? "bg-blue-50 dark:bg-blue-950 text-blue-700 dark:text-blue-300" : "text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-900"}`} aria-current={isActive ? "page" : undefined}>
                                    {item.name}
                                </a>
                            </li>
                        );
                    })
                }
            </ul>
        </div>
    </div>
</header>

<script>
    // Use astro:page-load to re-bind handlers after every View Transition navigation
    document.addEventListener("astro:page-load", () => {
        // Mobile menu toggle
        const btn = document.getElementById("mobile-menu-btn");
        const menu = document.getElementById("mobile-menu");
        const hamburger = document.getElementById("hamburger-icon");
        const closeIcon = document.getElementById("close-icon");

        btn?.addEventListener("click", () => {
            const isOpen = !menu?.classList.contains("hidden");
            menu?.classList.toggle("hidden");
            hamburger?.classList.toggle("hidden", isOpen);
            closeIcon?.classList.toggle("hidden", !isOpen);
            btn.setAttribute("aria-expanded", String(!isOpen));
        });

        // Theme toggle: sync icons with current state
        const isDark = document.documentElement.classList.contains("dark");
        document.getElementById("theme-icon-moon")?.classList.toggle("hidden", isDark);
        document.getElementById("theme-icon-sun")?.classList.toggle("hidden", !isDark);

        document.getElementById("theme-toggle")?.addEventListener("click", () => {
            const nowDark = document.documentElement.classList.toggle("dark");
            localStorage.setItem("theme", nowDark ? "dark" : "light");
            document.getElementById("theme-icon-moon")?.classList.toggle("hidden", nowDark);
            document.getElementById("theme-icon-sun")?.classList.toggle("hidden", !nowDark);
        });

        // Language persistence: detect language from URL and update links
        const pathMatch = window.location.pathname.match(/^\/(de|en)\//);
        if (pathMatch) {
            localStorage.setItem("preferredLang", pathMatch[1]);
        }
        const preferredLang = localStorage.getItem("preferredLang");
        if (preferredLang) {
            const otherLang = preferredLang === "en" ? "de" : "en";
            // Update header links (nav items + mobile menu) and data-lang-link elements
            // but skip the language switcher itself
            document.querySelectorAll(`header a[href^="/${otherLang}/"], [data-lang-link][href^="/${otherLang}/"]`).forEach((link) => {
                if (link.closest("[data-lang-switcher]")) return;
                const href = link.getAttribute("href");
                if (href) {
                    link.setAttribute("href", href.replace(`/${otherLang}/`, `/${preferredLang}/`));
                }
            });
        }
    });
</script>
