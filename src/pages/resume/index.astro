---
import ResumeLayout from "../../layouts/ResumeLayout.astro";
import { getCollection } from "astro:content";

const resumes = await getCollection("resume");

// Sort by date descending (newest first)
const sorted = resumes.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
---

<ResumeLayout title="Resume-Übersicht" description="Übersicht aller Lebensläufe" lang="de">

    <!-- Password gate -->
    <div id="gate" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md max-w-sm w-full">
            <h1 class="text-lg font-bold text-gray-900 mb-4">Resume-Übersicht</h1>
            <p class="text-sm text-gray-500 mb-4">Bitte Passwort eingeben, um die Übersicht anzuzeigen.</p>
            <form id="pw-form" class="flex gap-2">
                <input
                    id="pw-input"
                    type="password"
                    placeholder="Passwort"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    autocomplete="off"
                />
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">OK</button>
            </form>
            <p id="pw-error" class="text-sm text-red-500 mt-2 hidden">Falsches Passwort.</p>
        </div>
    </div>

    <!-- Protected content -->
    <div id="content" class="hidden min-h-screen bg-gray-100">
        <div class="max-w-3xl mx-auto px-6 py-10">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Resume-Übersicht</h1>
                <div class="flex gap-3">
                    <a href="/resume-de" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. DE</a>
                    <a href="/resume-en" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. EN</a>
                </div>
            </div>

            <p class="text-sm text-gray-500 mb-6">{sorted.length} Lebenslauf/Lebensläufe gespeichert.</p>

            <div class="space-y-3">
                {sorted.map((r) => {
                    const d = new Date(r.data.date);
                    const dateStr = d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" });
                    return (
                        <a href={`/resume/${r.slug}/`} class="block bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow border border-gray-100">
                            <div class="flex items-start justify-between gap-4">
                                <div>
                                    <p class="font-semibold text-gray-900">{r.data.position}</p>
                                    <p class="text-sm text-gray-500">{r.data.company}</p>
                                    {r.data.cvData && <p class="text-xs text-blue-600 mt-1">Custom CV: {r.data.cvData}</p>}
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="text-sm text-gray-400">{dateStr}</p>
                                    <p class="text-xs text-gray-400 font-mono mt-1">{r.slug}</p>
                                    <span class:list={["inline-block mt-1 text-xs px-2 py-0.5 rounded-full", r.data.lang === "de" ? "bg-gray-100 text-gray-600" : "bg-blue-50 text-blue-600"]}>
                                        {r.data.lang === "de" ? "DE" : "EN"}
                                    </span>
                                </div>
                            </div>
                        </a>
                    );
                })}
            </div>
        </div>
    </div>

    <script>
        // Simple client-side password gate.
        // The password hash is checked against a SHA-256 hash stored here.
        // This is NOT cryptographically secure (content is in the HTML), but prevents casual access.
        const HASH = "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"; // sha256("password")

        async function sha256(message: string): Promise<string> {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        }

        // Check if already authenticated in this session
        if (sessionStorage.getItem("resume-auth") === "1") {
            document.getElementById("gate")!.classList.add("hidden");
            document.getElementById("content")!.classList.remove("hidden");
        }

        document.getElementById("pw-form")!.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("pw-input") as HTMLInputElement;
            const hash = await sha256(input.value);
            if (hash === HASH) {
                sessionStorage.setItem("resume-auth", "1");
                document.getElementById("gate")!.classList.add("hidden");
                document.getElementById("content")!.classList.remove("hidden");
            } else {
                document.getElementById("pw-error")!.classList.remove("hidden");
                input.value = "";
                input.focus();
            }
        });
    </script>
</ResumeLayout>
