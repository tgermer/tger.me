---
import { Image } from "astro:assets";
import ResumeLayout from "../../layouts/ResumeLayout.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import * as cvDe from "../../data/cv_de";
import * as cvEn from "../../data/cv_en";
import signatureSvg from "../../assets/signature.svg?raw";

const imageModules = import.meta.glob<{ default: ImageMetadata }>("../../assets/apply/*.{jpg,jpeg,png}", { eager: true });

// Eagerly import all CV data files so custom ones can be resolved at build time
const cvModules = import.meta.glob("../../data/cv_*.ts", { eager: true }) as Record<string, any>;

export async function getStaticPaths() {
    const resumes = await getCollection("apply");
    return resumes.map((resume) => ({
        params: { slug: resume.slug },
        props: { resume },
    }));
}

const { resume } = Astro.props;
const { initiative, position, company, lang, date, cvData, signature, salutation, companyAddress } = resume.data;

// Render markdown body (cover letter)
const { Content } = await resume.render();
const hasLetter = resume.body && resume.body.trim().length > 0;

const isDE = lang === "de";

// Display logic for speculative applications (Initiativbewerbung)
const initiativeLabel = isDE ? "Initiativbewerbung" : "Speculative Application";
const displayPosition = initiative
    ? (position ? (isDE ? `${initiativeLabel} als ${position}` : `${initiativeLabel} for ${position}`) : initiativeLabel)
    : position || "";
const coverLabel = initiative
    ? (position ? (isDE ? "Initiativbewerbung als" : "Speculative Application for") : "")
    : (isDE ? "Bewerbung als" : "Application for");
const coverTitle = initiative && !position ? initiativeLabel : position || "";

// Use custom CV data file if specified, otherwise fall back to default
let cv: any;
if (cvData) {
    const key = `../../data/${cvData}.ts`;
    cv = cvModules[key];
    if (!cv) {
        throw new Error(`Custom CV data file not found: src/data/${cvData}.ts`);
    }
} else {
    cv = isDE ? cvDe : cvEn;
}

const p = cv.personal;

// Resolve photo from src/assets/
const photoKey = `../../assets/apply/${p.photo}`;
const photoModule = imageModules[photoKey];
if (!photoModule) throw new Error(`Photo not found: src/assets/${p.photo}`);
const photoImage = photoModule.default;

const l = isDE
    ? {
          homeLabel: "tger.me besuchen",
          overviewLabel: "Übersicht",
          downloadLabel: "Lebenslauf herunterladen",
          applicationFor: coverLabel,
          experienceHeading: "Beruflicher Werdegang",
          educationHeading: "Hochschulausbildung",
          furtherEducationHeading: "Zusatzqualifikationen",
          projectsHeading: "Projekte",
          skillsHeading: "Kenntnisse",
          referencesHeading: "Referenzen",
          since: "Seit",
          major: "Schwerpunkt",
          thesis: "Thesis",
          birthday: "Geburtstag",
          languages: "Arbeitssprachen",
          residence: "Wohnort",
          contact: "Kontakt",
          online: "Online",
          letterSubject: displayPosition,
          letterClosing: "Mit freundlichen Grüßen",
          letterPdfLabel: "Anschreiben herunterladen",
          letterPdfLabelShort: "Anschreiben",
          downloadLabelShort: "Lebenslauf",
      }
    : {
          homeLabel: "Visit tger.me",
          overviewLabel: "Overview",
          downloadLabel: "Download CV",
          applicationFor: coverLabel,
          experienceHeading: "Professional Experience",
          educationHeading: "University Education",
          furtherEducationHeading: "Additional Qualifications",
          projectsHeading: "Projects",
          skillsHeading: "Skills",
          referencesHeading: "References",
          since: "Since",
          major: "Major",
          thesis: "Thesis",
          birthday: "Date of Birth",
          languages: "Working Languages",
          residence: "Residence",
          contact: "Contact",
          online: "Online",
          letterSubject: displayPosition,
          letterClosing: "Best regards,",
          letterPdfLabel: "Download cover letter",
          letterPdfLabelShort: "Letter",
          downloadLabelShort: "CV",
      };

function formatDate(dateStr: string): string {
    if (!dateStr) return "";
    const [year, month] = dateStr.split("-");
    return `${month}/${year}`;
}

const formattedResumeDate = isDE ? new Date(date).toLocaleDateString("de-DE", { day: "numeric", month: "long", year: "numeric" }) : new Date(date).toLocaleDateString("en-US", { day: "numeric", month: "long", year: "numeric" });

const pageTitle = isDE ? `Lebenslauf – ${p.name} – ${displayPosition}` : `CV – ${p.name} – ${displayPosition}`;

const headerTitle = `${p.name} | ${displayPosition}`;
---

<ResumeLayout title={pageTitle} description={`${displayPosition} – ${company}`} lang={lang}>
    <!-- Print toolbar (hidden in print) -->
    <div class="resume-toolbar">
        <div class="max-w-[210mm] mx-auto px-1 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
                <a id="back-to-overview" href="/apply" class="items-center gap-1 text-gray-500 hover:text-gray-900 transition-colors hidden"><Icon name="tabler:chevron-left" class="h-4 w-4" />{l.overviewLabel}</a>
                <a href="/" class="hidden sm:inline-flex items-center gap-1 text-gray-500 hover:text-gray-900 transition-colors"><Icon name="tabler:world-www" class="h-4 w-4" />{l.homeLabel}</a>
            </div>
            <div class="flex items-center gap-2">
                {hasLetter && (
                    <a href={`/apply/${resume.slug}-letter.pdf`} target="_blank" class="inline-flex items-center gap-1.5 text-sm px-2.5 sm:px-4 py-1.5 border border-blue-600 text-blue-600 rounded-full hover:bg-blue-50 transition-colors">
                        <Icon name="tabler:file-type-pdf" class="h-4 w-4" />
                        <span class="hidden sm:inline">{l.letterPdfLabel}</span>
                        <span class="sm:hidden">{l.letterPdfLabelShort}</span>
                    </a>
                )}
                <a href={`/apply/${resume.slug}.pdf`} target="_blank" class="inline-flex items-center gap-1.5 text-sm px-2.5 sm:px-4 py-1.5 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors">
                    <Icon name="tabler:file-type-pdf" class="h-4 w-4" />
                    <span class="hidden sm:inline">{l.downloadLabel}</span>
                    <span class="sm:hidden">{l.downloadLabelShort}</span>
                </a>
            </div>
        </div>
    </div>

    <!-- ==================== PAGE 1: COVER ==================== -->
    <div class="resume-page resume-cover">
        <!-- Blue header bar -->
        <div class="cover-header-bar"></div>

        <!-- Application info -->
        <div class="cover-application">
            {l.applicationFor && <p class="cover-application-label">{l.applicationFor}</p>}
            <h1 class="cover-application-title">{coverTitle}</h1>
            <p class="cover-application-company">{company}</p>
        </div>

        <!-- Photo, name, tagline, data – anchored to bottom -->
        <div class="cover-bottom">
            <Image src={photoImage} alt={p.name} class="cover-photo" />
            <h2 class="cover-name">{p.name}</h2>
            <p class="cover-tagline">{p.tagline}</p>

            <div class="resume-table-scroll">
            <table class="cover-data-table">
                <tr>
                    <td class="cover-data-label">{l.birthday}</td>
                    <td class="cover-data-value">{p.birthdate}</td>
                </tr>
                <tr>
                    <td class="cover-data-label">{l.languages}</td>
                    <td class="cover-data-value">{p.languageValues}</td>
                </tr>
                <tr>
                    <td class="cover-data-label">{l.residence}</td>
                    <td class="cover-data-value">{p.address}</td>
                </tr>
                <tr>
                    <td class="cover-data-label">{l.contact}</td>
                    <td class="cover-data-value"><a href={`tel:${p.phone}`} target="_blank" rel="noopener noreferrer">{p.phone}</a> | <a href={`mailto:${p.email}`} target="_blank" rel="noopener noreferrer">{p.email}</a></td>
                </tr>
                {(p.url || p.linkedinUrl || p.githubUrl) && (
                    <tr>
                        <td class="cover-data-label">{l.online}</td>
                        <td class="cover-data-value">
                            {[
                                p.url && <a href={`https://${p.url}`} target="_blank" rel="noopener noreferrer">{p.url}</a>,
                                p.linkedinUrl && <a href={`https://${p.linkedinUrl}`} target="_blank" rel="noopener noreferrer">{p.linkedinUrl}</a>,
                                p.githubUrl && <a href={`https://${p.githubUrl}`} target="_blank" rel="noopener noreferrer">{p.githubUrl}</a>,
                            ].filter(Boolean).reduce((acc, el, i) => i === 0 ? [el] : [...acc, ' | ', el], [])}
                        </td>
                    </tr>
                )}
            </table>
            </div>
        </div>
    </div>

    <!-- ==================== COVER LETTER (Anschreiben) ==================== -->
    {hasLetter && (
        <div class="resume-page resume-letter">
            <!-- Blue gradient bar (same as cover page) -->
            <div class="letter-header-bar"></div>

            <!-- 12–27 mm: sender name -->
            <div class="letter-head">
                <p class="letter-head-name">{p.name}</p>
            </div>

            <!-- Address field (DIN 5008 Form A) -->
            <div class="letter-address-field">
                <!-- Rücksenderangabe (return address, small) -->
                <div class="letter-return-address">
                    {p.name} · {p.address}
                </div>
                <!-- Recipient address (Anschriftenzone) -->
                <div class="letter-recipient">
                    {resume.data.contact && <p>{resume.data.contact}</p>}
                    <p>{company}</p>
                    {companyAddress && companyAddress.split('\n').map((line) => (
                        <p>{line}</p>
                    ))}
                </div>
            </div>

            <!-- Letter content area -->
            <div class="letter-content">
                <div class="letter-date">
                    {p.location}, {formattedResumeDate}
                </div>

                <div class="letter-subject">
                    {l.letterSubject}
                </div>

                <div class="letter-body">
                    {salutation && <p>{salutation}</p>}
                    <Content />
                </div>

                <div class="letter-closing">
                    <p>{l.letterClosing}</p>
                    {signature && (
                        <div class="resume-signature letter-signature">
                            <Fragment set:html={signatureSvg} />
                        </div>
                    )}
                    <p class="letter-closing-name">{p.name}</p>
                </div>
            </div>
        </div>
    )}

    <!-- ==================== PAGE 2+: CV CONTENT ==================== -->
    <div class="resume-page resume-cv-content">
        <!-- Page header (repeats in print via running header CSS) -->
        <div class="cv-page-header">
            <span>{headerTitle}</span>
        </div>

        <!-- Berufserfahrung -->
        <section class="resume-section">
            <h2 class="resume-heading">{l.experienceHeading}</h2>
            <table class="resume-table">
                {
                    cv.experience.map((job, i) => (
                        <tr class:list={["resume-entry", { "resume-entry-border": i > 0 }]}>
                            <td class="resume-date">
                                {job.endDate ? (
                                    <>
                                        {formatDate(job.startDate)}
                                        <br />
                                        {formatDate(job.endDate)}
                                    </>
                                ) : (
                                    `${l.since} ${formatDate(job.startDate)}`
                                )}
                            </td>
                            <td class="resume-detail">
                                {job.position && job.position.length > 0 ? (
                                    <>
                                        <p class="resume-entry-title">{job.position.join(", ")}</p>
                                        <p class="resume-entry-sub">{job.company}{job.location && `, ${job.location}`}<span class="resume-employment-type"> · {job.typeOfEmployment}</span></p>
                                    </>
                                ) : (
                                    <>
                                        <p class="resume-entry-title">{job.company}</p>
                                        {job.location && (
                                            <p class="resume-entry-sub">
                                                {job.location} · {job.typeOfEmployment}
                                            </p>
                                        )}
                                        {!job.location && <p class="resume-entry-sub">{job.typeOfEmployment}</p>}
                                    </>
                                )}
                                {job.description?.list && job.description.list.length > 0 && (
                                    <ul class="resume-list">
                                        {job.description.list.map((item) => (
                                            <li>{item}</li>
                                        ))}
                                    </ul>
                                )}
                            </td>
                        </tr>
                    ))
                }
            </table>
        </section>

        <!-- Hochschulausbildung – 3-column table -->
        <section class="resume-section">
            <h2 class="resume-heading">{l.educationHeading}</h2>
            <div class="resume-table-scroll">
            <table class="resume-table">
                {
                    cv.education.map((edu, i) => (
                        <tr class:list={["resume-entry", { "resume-entry-border": i > 0 }]}>
                            <td class="resume-date">
                                {formatDate(edu.startDate)}
                                <br />
                                {formatDate(edu.endDate)}
                            </td>
                            <td class="resume-detail-mid">
                                <p class="resume-entry-title">
                                    {edu.fieldOfStudy}, {edu.degree}
                                </p>
                                {edu.majorFieldOfStudy && (
                                    <p class="resume-entry-meta">
                                        {l.major}: {edu.majorFieldOfStudy}
                                    </p>
                                )}
                                {edu.thesis?.title && (
                                    <p class="resume-entry-meta">
                                        {l.thesis}: {edu.thesis.title}
                                    </p>
                                )}
                            </td>
                            <td class="resume-detail-right">
                                <p class="resume-entry-sub">{edu.school}</p>
                                {edu.location && <p class="resume-entry-meta">{edu.location}</p>}
                            </td>
                        </tr>
                    ))
                }
            </table>
            </div>
        </section>

        <!-- Zusatzqualifikationen – 3-column table -->
        <section class="resume-section">
            <h2 class="resume-heading">{l.furtherEducationHeading}</h2>
            <div class="resume-table-scroll">
            <table class="resume-table">
                {
                    cv.furtherEducation.map((edu, i) => (
                        <tr class:list={["resume-entry", { "resume-entry-border": i > 0 }]}>
                            <td class="resume-date">
                                {formatDate(edu.startDate) === formatDate(edu.endDate) ? (
                                    formatDate(edu.startDate)
                                ) : (
                                    <>
                                        {formatDate(edu.startDate)}
                                        <br />
                                        {formatDate(edu.endDate)}
                                    </>
                                )}
                            </td>
                            <td class="resume-detail-mid">
                                <p class="resume-entry-title">
                                    {edu.fieldOfStudy}{edu.degree && `, ${edu.degree}`}
                                </p>
                            </td>
                            <td class="resume-detail-right">
                                <p class="resume-entry-sub">{edu.school}</p>
                                {edu.location && <p class="resume-entry-meta">{edu.location}</p>}
                            </td>
                        </tr>
                    ))
                }
            </table>
            </div>
        </section>

        <!-- Projekte -->
        {
            cv.projects?.length > 0 && (
                <section class="resume-section">
                    <h2 class="resume-heading">{l.projectsHeading}</h2>
                    <table class="resume-table">
                        {cv.projects.map((project, i) => (
                            <tr class:list={["resume-entry", { "resume-entry-border": i > 0 }]}>
                                <td class="resume-date">{formatDate(project.date)}</td>
                                <td class="resume-detail">
                                    <p class="resume-entry-title">{project.title}</p>
                                    {project.description?.list && project.description.list.length > 0 && (
                                        <ul class="resume-list">
                                            {project.description.list.map((item) => (
                                                <li>{item}</li>
                                            ))}
                                        </ul>
                                    )}
                                </td>
                            </tr>
                        ))}
                    </table>
                </section>
            )
        }

        <!-- Kenntnisse -->
        {
            cv.skills?.length > 0 && (
                <section class="resume-section">
                    <h2 class="resume-heading">{l.skillsHeading}</h2>
                    <div class="resume-skills-grid">
                        {cv.skills.map((cat) => (
                            <div class="resume-skill-group">
                                <h3 class="resume-skill-label">{cat.catagorie}</h3>
                                <ul class="resume-skill-items">
                                    {cat.items.map((item) => (
                                        <li>{item}</li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </section>
            )
        }

        <!-- Referenzen -->
        {
            cv.references?.length > 0 && (
                <section class="resume-section">
                    <h2 class="resume-heading">{l.referencesHeading}</h2>
                    <dl class="resume-references">
                        {cv.references.map((ref) => (
                            <div class="resume-reference">
                                <dt class="resume-entry-title">{ref.name}</dt>
                                <dd class="resume-entry-sub">
                                    {ref.position}, {ref.company}
                                </dd>
                                {ref.department && <dd class="resume-entry-meta">{ref.department}</dd>}
                                <dd class="resume-entry-meta">{ref.email}</dd>
                            </div>
                        ))}
                    </dl>
                </section>
            )
        }

        <!-- Date + Location footer -->
        <div class="resume-date-footer">
            {p.location}, {formattedResumeDate}
            {signature && (
                <div class="resume-signature">
                    <Fragment set:html={signatureSvg} />
                </div>
            )}
        </div>
    </div>

    <script>
        // Show "back to overview" link only when coming from /apply overview or in dev mode
        try {
            const ref = document.referrer ? new URL(document.referrer) : null;
            const isFromOverview = ref && ref.pathname === "/apply" || ref?.pathname === "/apply/";
            const isDevMode = location.hostname === "localhost" || location.hostname === "127.0.0.1";
            if (isFromOverview || isDevMode) {
                const el = document.getElementById("back-to-overview");
                el?.classList.remove("hidden");
                el?.classList.add("inline-flex");
            }
        } catch {}
    </script>
</ResumeLayout>
