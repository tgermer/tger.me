---
import ResumeLayout from "../../layouts/ResumeLayout.astro";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import { site } from "../../data/site";

const resumes = await getCollection("apply");

// Sort by date descending (newest first)
const sorted = resumes.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const statusLabels: Record<string, string> = {
    beworben: "Beworben",
    "eingangsbestätigung": "Eingangsbestätigung",
    "vorstellungsgespräch": "Vorstellungsgespräch",
    "zweitgespräch": "Zweitgespräch",
    assessment: "Assessment",
    angebot: "Angebot",
    zusage: "Zusage",
    absage: "Absage",
    "zurückgezogen": "Zurückgezogen",
};

const statusColors: Record<string, string> = {
    beworben: "bg-gray-100 text-gray-700",
    "eingangsbestätigung": "bg-blue-50 text-blue-700",
    "vorstellungsgespräch": "bg-indigo-50 text-indigo-700",
    "zweitgespräch": "bg-violet-50 text-violet-700",
    assessment: "bg-purple-50 text-purple-700",
    angebot: "bg-amber-50 text-amber-700",
    zusage: "bg-green-50 text-green-700",
    absage: "bg-red-50 text-red-700",
    "zurückgezogen": "bg-stone-100 text-stone-500",
};

function getCurrentStatus(history: Array<{ status: string; date: Date }>) {
    if (history.length === 0) return null;
    // Sort by date ascending, take last
    const sorted = [...history].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
    return sorted[sorted.length - 1];
}

function formatDate(date: Date) {
    return new Date(date).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" });
}

function buildContactMailto(email: string, position: string, lang: string, contact?: string) {
    const greeting = lang === "de"
        ? (contact ? `Hallo ${contact},` : "Sehr geehrte Damen und Herren,")
        : (contact ? `Hello ${contact},` : "Dear Hiring Team,");
    return `mailto:${email}?subject=${encodeURIComponent(position)}&body=${encodeURIComponent(greeting + "\n\n")}`;
}

function buildMailtoUrl(position: string, company: string, slug: string, lang: string, email?: string, contact?: string) {
    const subject = lang === "de"
        ? `Bewerbung als ${position} – ${site.author}`
        : `Application for ${position} – ${site.author}`;
    const pdfUrl = `${site.url}/apply/${slug}.pdf`;
    const greeting = lang === "de"
        ? (contact ? `Hallo ${contact},` : "Sehr geehrte Damen und Herren,")
        : (contact ? `Hello ${contact},` : "Dear hiring team,");
    const body = lang === "de"
        ? `${greeting}\n\nanbei erhalten Sie meine Bewerbung als ${position} bei ${company}.\n\nMeinen Lebenslauf finden Sie auch unter:\n${pdfUrl}\n\nMit freundlichen Grüßen\n${site.author}`
        : `${greeting}\n\nPlease find attached my application for the ${position} role at ${company}.\n\nMy resume is also available at:\n${pdfUrl}\n\nBest regards,\n${site.author}`;
    return `mailto:${email || ""}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
---

<ResumeLayout title="Bewerbungen" description="Übersicht aller Bewerbungen" lang="de">

    <!-- Password gate -->
    <div id="gate" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md max-w-sm w-full">
            <h1 class="text-lg font-bold text-gray-900 mb-4">Bewerbungen</h1>
            <p class="text-sm text-gray-500 mb-4">Bitte Passwort eingeben, um die Übersicht anzuzeigen.</p>
            <form id="pw-form" class="flex gap-2">
                <input
                    id="pw-input"
                    type="password"
                    placeholder="Passwort"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    autocomplete="off"
                />
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors">OK</button>
            </form>
            <p id="pw-error" class="text-sm text-red-500 mt-2 hidden">Falsches Passwort.</p>
        </div>
    </div>

    <!-- Protected content -->
    <div id="content" class="hidden min-h-screen bg-gray-100">
        <div class="max-w-7xl mx-auto px-6 py-10">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Bewerbungen</h1>
                <div class="flex gap-3">
                    <a href="/resume-de" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. DE</a>
                    <a href="/resume-en" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. EN</a>
                </div>
            </div>

            <p class="text-sm text-gray-500 mb-6">{sorted.length} Bewerbung(en) gespeichert.</p>

            <!-- Mobile: stacked cards -->
            <div class="md:hidden flex flex-col gap-3">
                {sorted.map((r) => {
                    const current = getCurrentStatus(r.data.statusHistory);
                    const statusKey = current?.status;
                    return (
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <div class="min-w-0">
                                    <a href={`/apply/${r.slug}/`} class="font-medium text-gray-900 hover:text-blue-600 transition-colors">
                                        {r.data.position}
                                    </a>
                                    <span class="ml-1.5 inline-block text-[10px] font-medium px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 uppercase align-middle">{r.data.lang}</span>
                                    <p class="text-sm text-gray-500">{r.data.company}</p>
                                </div>
                                {statusKey && (
                                    <span class:list={["shrink-0 text-xs font-medium px-2 py-1 rounded-full", statusColors[statusKey] || "bg-gray-100 text-gray-700"]}>
                                        {statusLabels[statusKey] || statusKey}
                                    </span>
                                )}
                            </div>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mb-3">
                                <span class="inline-flex items-center gap-1"><Icon name="tabler:calendar" class="h-3.5 w-3.5" />{formatDate(r.data.date)}</span>
                                {r.data.location && <span class="inline-flex items-center gap-1"><Icon name="tabler:map-pin" class="h-3.5 w-3.5" />{r.data.location}</span>}
                                {r.data.source && <span class="inline-flex items-center gap-1"><Icon name="tabler:world" class="h-3.5 w-3.5" />{r.data.source}</span>}
                                {r.data.salary && <span class="inline-flex items-center gap-1"><Icon name="tabler:currency-euro" class="h-3.5 w-3.5" />{r.data.salary}</span>}
                            </div>
                            {r.data.contact && (
                                <p class="text-xs text-gray-500 mb-2 inline-flex items-center gap-1">
                                    <Icon name="tabler:user" class="h-3.5 w-3.5" />
                                    {r.data.contact}
                                    {r.data.contactEmail && <span class="text-gray-400"> · <a href={buildContactMailto(r.data.contactEmail, r.data.position, r.data.lang, r.data.contact)} class="hover:text-blue-600 transition-colors">{r.data.contactEmail}</a></span>}
                                </p>
                            )}
                            {r.data.notes && (
                                <p class="text-xs text-gray-400 mb-2 truncate" title={r.data.notes}>{r.data.notes}</p>
                            )}
                            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                                <a href={`/apply/${r.slug}/`} class="text-blue-600 hover:text-blue-800" title="Lebenslauf"><Icon name="tabler:file-text" class="h-4 w-4" /></a>
                                <a href={`/apply/${r.slug}.pdf`} class="text-gray-400 hover:text-gray-600" title="CV PDF"><Icon name="tabler:download" class="h-4 w-4" /></a>
                                {r.data.jobUrl && (
                                    <a href={r.data.jobUrl} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-600" title="Stellenanzeige"><Icon name="tabler:external-link" class="h-4 w-4" /></a>
                                )}
                                <a href={buildMailtoUrl(r.data.position, r.data.company, r.slug, r.data.lang, r.data.contactEmail, r.data.contact)} class="text-gray-400 hover:text-gray-600" title={r.data.contactEmail ? `E-Mail an ${r.data.contactEmail}` : "E-Mail verfassen"}><Icon name="tabler:mail" class="h-4 w-4" /></a>
                            </div>
                        </div>
                    );
                })}
            </div>

            <!-- Desktop: table -->
            <div class="hidden md:block overflow-x-auto bg-white rounded-lg shadow-sm border border-gray-200">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider">
                        <tr>
                            <th class="px-4 py-3">Datum</th>
                            <th class="px-4 py-3">Position / Firma</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">Kontakt</th>
                            <th class="px-4 py-3">Quelle</th>
                            <th class="px-4 py-3">Standort</th>
                            <th class="px-4 py-3">Gehalt</th>
                            <th class="px-4 py-3">Links</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {sorted.map((r) => {
                            const current = getCurrentStatus(r.data.statusHistory);
                            const statusKey = current?.status;
                            return (
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <p class="text-gray-900">{formatDate(r.data.date)}</p>
                                        <p class="text-xs text-gray-400 font-mono">{r.slug}</p>
                                    </td>
                                    <td class="px-4 py-3">
                                        <a href={`/apply/${r.slug}/`} class="font-medium text-gray-900 hover:text-blue-600 transition-colors">
                                            {r.data.position}
                                        </a>
                                        <span class="ml-1.5 inline-block text-[10px] font-medium px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 uppercase align-middle">{r.data.lang}</span>
                                        <p class="text-gray-500">{r.data.company}</p>
                                        {r.data.notes && (
                                            <p class="text-xs text-gray-400 mt-1 max-w-xs truncate" title={r.data.notes}>{r.data.notes}</p>
                                        )}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        {statusKey ? (
                                            <span class:list={["inline-block text-xs font-medium px-2 py-1 rounded-full", statusColors[statusKey] || "bg-gray-100 text-gray-700"]}>
                                                {statusLabels[statusKey] || statusKey}
                                            </span>
                                        ) : (
                                            <span class="text-xs text-gray-300">–</span>
                                        )}
                                        {current?.date && (
                                            <p class="text-xs text-gray-400 mt-1">{formatDate(current.date)}</p>
                                        )}
                                    </td>
                                    <td class="px-4 py-3 text-gray-600">
                                        {r.data.contact || <span class="text-gray-300">–</span>}
                                        {r.data.contactEmail && (
                                            <p class="text-xs text-gray-400 truncate max-w-40" title={r.data.contactEmail}><a href={buildContactMailto(r.data.contactEmail, r.data.position, r.data.lang, r.data.contact)} class="hover:text-blue-600 transition-colors">{r.data.contactEmail}</a></p>
                                        )}
                                    </td>
                                    <td class="px-4 py-3 text-gray-600">
                                        {r.data.source || <span class="text-gray-300">–</span>}
                                    </td>
                                    <td class="px-4 py-3 text-gray-600">
                                        {r.data.location || <span class="text-gray-300">–</span>}
                                    </td>
                                    <td class="px-4 py-3 text-gray-600 whitespace-nowrap">
                                        {r.data.salary || <span class="text-gray-300">–</span>}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <a href={`/apply/${r.slug}/`} class="text-blue-600 hover:text-blue-800" title="Lebenslauf"><Icon name="tabler:file-text" class="h-4 w-4" /></a>
                                            <a href={`/apply/${r.slug}.pdf`} class="text-gray-400 hover:text-gray-600" title="CV PDF"><Icon name="tabler:download" class="h-4 w-4" /></a>
                                            {r.data.jobUrl && (
                                                <a href={r.data.jobUrl} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-600" title="Stellenanzeige"><Icon name="tabler:external-link" class="h-4 w-4" /></a>
                                            )}
                                            <a href={buildMailtoUrl(r.data.position, r.data.company, r.slug, r.data.lang, r.data.contactEmail, r.data.contact)} class="text-gray-400 hover:text-gray-600" title={r.data.contactEmail ? `E-Mail an ${r.data.contactEmail}` : "E-Mail verfassen"}><Icon name="tabler:mail" class="h-4 w-4" /></a>
                                        </div>
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Simple client-side password gate.
        // The password hash is checked against a SHA-256 hash stored here.
        // This is NOT cryptographically secure (content is in the HTML), but prevents casual access.
        const HASH = "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"; // sha256("password")

        async function sha256(message: string): Promise<string> {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
        }

        // Check if already authenticated in this session
        if (sessionStorage.getItem("apply-auth") === "1") {
            document.getElementById("gate")!.classList.add("hidden");
            document.getElementById("content")!.classList.remove("hidden");
        }

        document.getElementById("pw-form")!.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("pw-input") as HTMLInputElement;
            const hash = await sha256(input.value);
            if (hash === HASH) {
                sessionStorage.setItem("apply-auth", "1");
                document.getElementById("gate")!.classList.add("hidden");
                document.getElementById("content")!.classList.remove("hidden");
            } else {
                document.getElementById("pw-error")!.classList.remove("hidden");
                input.value = "";
                input.focus();
            }
        });
    </script>
</ResumeLayout>
