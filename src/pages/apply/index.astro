---
import ResumeLayout from "../../layouts/ResumeLayout.astro";
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import { site } from "../../data/site";

const resumes = await getCollection("apply");

// Sort by date descending (newest first)
const sorted = resumes.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const statusLabels: Record<string, string> = {
    beworben: "Beworben",
    eingangsbestätigung: "Eingangsbestätigung",
    vorstellungsgespräch: "Vorstellungsgespräch",
    zweitgespräch: "Zweitgespräch",
    assessment: "Assessment",
    angebot: "Angebot",
    zusage: "Zusage",
    absage: "Absage",
    zurückgezogen: "Zurückgezogen",
};

const statusColors: Record<string, string> = {
    beworben: "bg-gray-100 text-gray-700",
    eingangsbestätigung: "bg-blue-50 text-blue-700",
    vorstellungsgespräch: "bg-indigo-50 text-indigo-700",
    zweitgespräch: "bg-violet-50 text-violet-700",
    assessment: "bg-purple-50 text-purple-700",
    angebot: "bg-amber-50 text-amber-700",
    zusage: "bg-green-50 text-green-700",
    absage: "bg-red-50 text-red-700",
    zurückgezogen: "bg-stone-100 text-stone-500",
};

const statusDotColors: Record<string, string> = {
    beworben: "bg-gray-400",
    eingangsbestätigung: "bg-blue-400",
    vorstellungsgespräch: "bg-indigo-400",
    zweitgespräch: "bg-violet-400",
    assessment: "bg-purple-400",
    angebot: "bg-amber-400",
    zusage: "bg-green-400",
    absage: "bg-red-400",
    zurückgezogen: "bg-stone-400",
};

const statusOrder: Record<string, number> = {
    beworben: 0,
    eingangsbestätigung: 1,
    vorstellungsgespräch: 2,
    zweitgespräch: 3,
    assessment: 4,
    angebot: 5,
    zusage: 6,
    absage: 7,
    zurückgezogen: 8,
};

function getCurrentStatus(history: Array<{ status: string; date: Date }>) {
    if (history.length === 0) return null;
    // Sort by date ascending, take last
    const sorted = [...history].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
    return sorted[sorted.length - 1];
}

function formatDate(date: Date) {
    return new Date(date).toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" });
}

function buildContactMailto(email: string, position: string, lang: string, contact?: string, salutation?: string) {
    const greeting = salutation || (lang === "de" ? (contact ? `Hallo ${contact},` : "Sehr geehrte Damen und Herren,") : contact ? `Hello ${contact},` : "Dear Hiring Team,");
    return `mailto:${email}?subject=${encodeURIComponent(position)}&body=${encodeURIComponent(greeting + "\n\n")}`;
}

function stripMarkdown(text: string): string {
    return text
        .replace(/\*\*(.*?)\*\*/g, "$1")
        .replace(/\*(.*?)\*/g, "$1")
        .replace(/\[(.*?)\]\(.*?\)/g, "$1");
}

function buildMailtoUrl(position: string, company: string, slug: string, lang: string, email?: string, contact?: string, letterBody?: string, source?: string, salutation?: string) {
    const subject = lang === "de" ? `Bewerbung als ${position} – ${site.author}` : `Application for ${position} – ${site.author}`;
    const pdfUrl = `${site.url}/apply/${slug}.pdf`;
    const greeting = salutation || (lang === "de" ? (contact ? `Hallo ${contact},` : "Sehr geehrte Damen und Herren,") : contact ? `Hello ${contact},` : "Dear hiring team,");
    const pdfNote = lang === "de" ? `Meinen Lebenslauf finden Sie auch unter:\n${pdfUrl}` : `My resume is also available at:\n${pdfUrl}`;
    const closing = lang === "de" ? `Mit freundlichen Grüßen\n${site.author}` : `Best regards,\n${site.author}`;

    let intro: string;
    if (lang === "de") {
        intro = source ? `über ${source} bin ich auf die Stelle als ${position} bei ${company} aufmerksam geworden und möchte mich hiermit bewerben.` : `hiermit möchte ich mich als ${position} bei ${company} bewerben.`;
    } else {
        intro = source ? `I came across the ${position} role at ${company} on ${source} and would like to apply.` : `I would like to apply for the ${position} role at ${company}.`;
    }

    let body: string;
    if (letterBody && letterBody.trim().length > 0) {
        const content = stripMarkdown(letterBody.trim());
        body = `${greeting}\n\n${intro}\n\n${content}\n\n${pdfNote}\n\n${closing}`;
    } else {
        body = `${greeting}\n\n${intro}\n\n${pdfNote}\n\n${closing}`;
    }
    return `mailto:${email || ""}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
---

<ResumeLayout title="Bewerbungen" description="Übersicht aller Bewerbungen" lang="de">
    <!-- Password gate -->
    <div id="gate" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md max-w-sm w-full">
            <h1 class="text-lg font-bold text-gray-900 mb-4">Bewerbungen</h1>
            <p class="text-sm text-gray-500 mb-4">Bitte Passwort eingeben, um die Übersicht anzuzeigen.</p>
            <form id="pw-form" class="flex gap-2">
                <input id="pw-input" type="password" placeholder="Passwort" class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off" />
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition-colors cursor-pointer">Login</button>
            </form>
            <p id="pw-error" class="text-sm text-red-500 mt-2 hidden">Falsches Passwort.</p>
        </div>
    </div>

    <!-- Protected content -->
    <div id="content" class="hidden min-h-screen bg-gray-100">
        <div class="max-w-7xl mx-auto px-6 py-10">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Bewerbungen</h1>
                <div class="flex items-center gap-3">
                    <a href="/cv-de-print" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. DE</a>
                    <a href="/cv-en-print" class="text-sm px-3 py-1.5 border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">Allg. EN</a>
                    <a href="/apply/cv-de.pdf" target="_blank" class="inline-flex items-center gap-1.5 text-sm px-3 py-1.5 border border-blue-600 text-blue-600 rounded-full hover:bg-blue-50 transition-colors"><Icon name="tabler:file-type-pdf" class="h-4 w-4" />Download DE</a>
                    <a href="/apply/cv-en.pdf" target="_blank" class="inline-flex items-center gap-1.5 text-sm px-3 py-1.5 border border-blue-600 text-blue-600 rounded-full hover:bg-blue-50 transition-colors"><Icon name="tabler:file-type-pdf" class="h-4 w-4" />Download EN</a>
                    <button id="lockout-btn" class="inline-flex items-center gap-1.5 text-sm px-3 py-1.5 border border-red-300 text-red-600 rounded-full hover:bg-red-50 transition-colors cursor-pointer" title="Sitzung sperren"><Icon name="tabler:lock" class="h-4 w-4" /></button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center mb-4">
                <div class="relative flex-1 w-full sm:max-w-xs">
                    <Icon name="tabler:search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" />
                    <input id="search-input" type="text" placeholder="Suchen…" class="w-full pl-9 pr-3 py-1.5 border border-gray-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" />
                </div>
                <div class="flex gap-1.5 flex-wrap text-xs">
                    <button data-sort="date" data-dir="desc" class="sort-btn border border-gray-800 bg-gray-800 text-white px-2.5 py-1 rounded-full transition-colors cursor-pointer">Datum ↓</button>
                    <button data-sort="update" class="sort-btn border border-gray-300 text-gray-600 hover:bg-gray-50 px-2.5 py-1 rounded-full transition-colors cursor-pointer">Update</button>
                    <button data-sort="status" class="sort-btn border border-gray-300 text-gray-600 hover:bg-gray-50 px-2.5 py-1 rounded-full transition-colors cursor-pointer">Status</button>
                    <button data-sort="company" class="sort-btn border border-gray-300 text-gray-600 hover:bg-gray-50 px-2.5 py-1 rounded-full transition-colors cursor-pointer">Firma</button>
                </div>
            </div>

            <p id="result-count" class="text-sm text-gray-500 mb-4">{sorted.length} Bewerbung(en) gespeichert.</p>

            <!-- Mobile: stacked cards -->
            <div id="card-container" class="md:hidden flex flex-col gap-3">
                {
                    sorted.map((r) => {
                        const current = getCurrentStatus(r.data.statusHistory);
                        const statusKey = current?.status;
                        const history = [...r.data.statusHistory].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                        const lastUpdate = history.length > 0 ? new Date(history[history.length - 1].date).toISOString() : new Date(r.data.date).toISOString();
                        const searchText = [
                            r.data.position,
                            r.data.company,
                            r.data.contact,
                            r.data.location,
                            r.data.source,
                            r.data.notes,
                            r.data.salary,
                            statusKey ? statusLabels[statusKey] : "",
                            r.data.statusHistory
                                .map((e) => e.info)
                                .filter(Boolean)
                                .join(" "),
                        ]
                            .filter(Boolean)
                            .join(" ")
                            .toLowerCase();
                        return (
                            <div data-expandable-card data-date={new Date(r.data.date).toISOString()} data-update={lastUpdate} data-status-order={String(statusOrder[statusKey || ""] ?? 99)} data-company={r.data.company.toLowerCase()} data-search={searchText} class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer">
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <div class="min-w-0">
                                        <a href={`/apply/${r.slug}/`} class="font-medium text-gray-900 hover:text-blue-600 transition-colors">
                                            {r.data.position}
                                        </a>
                                        <span class="ml-1.5 inline-block text-[10px] font-medium px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 uppercase align-middle">{r.data.lang}</span>
                                        <p class="text-sm text-gray-500">{r.data.company}</p>
                                    </div>
                                    <div class="flex items-center gap-1 shrink-0">
                                        {statusKey && <span class:list={["text-xs font-medium px-2 py-1 rounded-full", statusColors[statusKey] || "bg-gray-100 text-gray-700"]}>{statusLabels[statusKey] || statusKey}</span>}
                                        {history.length > 0 && <Icon name="tabler:chevron-down" class="expand-icon h-3.5 w-3.5 text-gray-400 transition-transform duration-200" />}
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mb-3">
                                    <span class="inline-flex items-center gap-1">
                                        <Icon name="tabler:calendar" class="h-3.5 w-3.5" />
                                        {formatDate(r.data.date)}
                                    </span>
                                    {r.data.location && (
                                        <span class="inline-flex items-center gap-1">
                                            <Icon name="tabler:map-pin" class="h-3.5 w-3.5" />
                                            {r.data.location}
                                        </span>
                                    )}
                                    {r.data.source && (
                                        <span class="inline-flex items-center gap-1">
                                            <Icon name="tabler:world" class="h-3.5 w-3.5" />
                                            {r.data.source}
                                        </span>
                                    )}
                                    {r.data.salary && (
                                        <span class="inline-flex items-center gap-1">
                                            <Icon name="tabler:currency-euro" class="h-3.5 w-3.5" />
                                            {r.data.salary}
                                        </span>
                                    )}
                                </div>
                                {r.data.contact && (
                                    <p class="text-xs text-gray-500 mb-2 inline-flex items-center gap-1">
                                        <Icon name="tabler:user" class="h-3.5 w-3.5" />
                                        {r.data.contact}
                                        {r.data.contactEmail && (
                                            <span class="text-gray-400">
                                                {" "}
                                                ·{" "}
                                                <a href={buildContactMailto(r.data.contactEmail, r.data.position, r.data.lang, r.data.contact, r.data.salutation)} class="hover:text-blue-600 transition-colors">
                                                    {r.data.contactEmail}
                                                </a>
                                            </span>
                                        )}
                                    </p>
                                )}
                                {r.data.notes && (
                                    <p class="text-xs text-gray-400 mb-2 truncate" title={r.data.notes}>
                                        {r.data.notes}
                                    </p>
                                )}
                                {history.length > 0 && (
                                    <div data-detail class="hidden border-t border-gray-100 pt-3 mb-2">
                                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">Status-Verlauf</p>
                                        {history.map((entry, i) => (
                                            <div class="flex gap-3">
                                                <div class="flex flex-col items-center">
                                                    <div class:list={["w-2.5 h-2.5 rounded-full shrink-0 mt-1", statusDotColors[entry.status] || "bg-gray-400"]} />
                                                    {i < history.length - 1 && <div class="w-px flex-1 bg-gray-200 min-h-4" />}
                                                </div>
                                                <div class:list={["min-w-0", i < history.length - 1 ? "pb-3" : ""]}>
                                                    <div class="flex items-center gap-2">
                                                        <span class:list={["text-xs font-medium px-2 py-0.5 rounded-full", statusColors[entry.status] || "bg-gray-100 text-gray-700"]}>{statusLabels[entry.status] || entry.status}</span>
                                                        <span class="text-xs text-gray-400">{formatDate(entry.date)}</span>
                                                    </div>
                                                    {entry.info && <p class="text-sm text-gray-600 mt-1 whitespace-pre-line">{entry.info}</p>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                                    <a href={`/apply/${r.slug}/`} class="text-blue-600 hover:text-blue-800" title="Lebenslauf">
                                        <Icon name="tabler:file-text" class="h-4 w-4" />
                                    </a>
                                    <a href={`/apply/${r.slug}.pdf`} class="text-gray-400 hover:text-gray-600" title="CV PDF">
                                        <Icon name="tabler:download" class="h-4 w-4" />
                                    </a>
                                    {r.body && r.body.trim().length > 0 && (
                                        <a href={`/apply/${r.slug}-letter.pdf`} class="text-gray-400 hover:text-gray-600" title="Anschreiben PDF">
                                            <Icon name="tabler:file-type-doc" class="h-4 w-4" />
                                        </a>
                                    )}
                                    {r.data.jobUrl && (
                                        <a href={r.data.jobUrl} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-600" title="Stellenanzeige">
                                            <Icon name="tabler:external-link" class="h-4 w-4" />
                                        </a>
                                    )}
                                    <a href={buildMailtoUrl(r.data.position, r.data.company, r.slug, r.data.lang, r.data.contactEmail, r.data.contact, r.body, r.data.source, r.data.salutation)} class="text-gray-400 hover:text-gray-600" title={r.data.contactEmail ? `E-Mail an ${r.data.contactEmail}` : "E-Mail verfassen"}>
                                        <Icon name="tabler:mail" class="h-4 w-4" />
                                    </a>
                                </div>
                            </div>
                        );
                    })
                }
            </div>

            <!-- Desktop: table -->
            <div class="hidden md:block overflow-x-auto bg-white rounded-lg shadow-sm border border-gray-200">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider">
                        <tr>
                            <th class="px-4 py-3">Datum</th>
                            <th class="px-4 py-3">Position / Firma</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3">Kontakt</th>
                            <th class="px-4 py-3">Quelle</th>
                            <th class="px-4 py-3">Standort</th>
                            <th class="px-4 py-3">Gehalt</th>
                            <th class="px-4 py-3">Links</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-gray-100">
                        {
                            sorted.map((r) => {
                                const current = getCurrentStatus(r.data.statusHistory);
                                const statusKey = current?.status;
                                const history = [...r.data.statusHistory].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
                                const lastUpdate = history.length > 0 ? new Date(history[history.length - 1].date).toISOString() : new Date(r.data.date).toISOString();
                                const searchText = [
                                    r.data.position,
                                    r.data.company,
                                    r.data.contact,
                                    r.data.location,
                                    r.data.source,
                                    r.data.notes,
                                    r.data.salary,
                                    statusKey ? statusLabels[statusKey] : "",
                                    r.data.statusHistory
                                        .map((e) => e.info)
                                        .filter(Boolean)
                                        .join(" "),
                                ]
                                    .filter(Boolean)
                                    .join(" ")
                                    .toLowerCase();
                                return (
                                    <>
                                        <tr data-expandable data-date={new Date(r.data.date).toISOString()} data-update={lastUpdate} data-status-order={String(statusOrder[statusKey || ""] ?? 99)} data-company={r.data.company.toLowerCase()} data-search={searchText} class="hover:bg-gray-50 transition-colors cursor-pointer">
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <p class="text-gray-900">{formatDate(r.data.date)}</p>
                                                <p class="text-xs text-gray-400 font-mono">{r.slug}</p>
                                            </td>
                                            <td class="px-4 py-3">
                                                <a href={`/apply/${r.slug}/`} class="font-medium text-gray-900 hover:text-blue-600 transition-colors">
                                                    {r.data.position}
                                                </a>
                                                <span class="ml-1.5 inline-block text-[10px] font-medium px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 uppercase align-middle">{r.data.lang}</span>
                                                <p class="text-gray-500">{r.data.company}</p>
                                                {r.data.notes && (
                                                    <p class="text-xs text-gray-400 mt-1 max-w-xs truncate" title={r.data.notes}>
                                                        {r.data.notes}
                                                    </p>
                                                )}
                                            </td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="flex items-center gap-1.5">
                                                    {statusKey ? <span class:list={["inline-block text-xs font-medium px-2 py-1 rounded-full", statusColors[statusKey] || "bg-gray-100 text-gray-700"]}>{statusLabels[statusKey] || statusKey}</span> : <span class="text-xs text-gray-300">–</span>}
                                                    {history.length > 0 && <Icon name="tabler:chevron-down" class="expand-icon h-3.5 w-3.5 text-gray-400 transition-transform duration-200" />}
                                                </div>
                                                {current?.date && <p class="text-xs text-gray-400 mt-1">{formatDate(current.date)}</p>}
                                            </td>
                                            <td class="px-4 py-3 text-gray-600">
                                                {r.data.contact || <span class="text-gray-300">–</span>}
                                                {r.data.contactEmail && (
                                                    <p class="text-xs text-gray-400 truncate max-w-40" title={r.data.contactEmail}>
                                                        <a href={buildContactMailto(r.data.contactEmail, r.data.position, r.data.lang, r.data.contact, r.data.salutation)} class="hover:text-blue-600 transition-colors">
                                                            {r.data.contactEmail}
                                                        </a>
                                                    </p>
                                                )}
                                            </td>
                                            <td class="px-4 py-3 text-gray-600">{r.data.source || <span class="text-gray-300">–</span>}</td>
                                            <td class="px-4 py-3 text-gray-600">{r.data.location || <span class="text-gray-300">–</span>}</td>
                                            <td class="px-4 py-3 text-gray-600 whitespace-nowrap">{r.data.salary || <span class="text-gray-300">–</span>}</td>
                                            <td class="px-4 py-3 whitespace-nowrap">
                                                <div class="flex items-center gap-2">
                                                    <a href={`/apply/${r.slug}/`} class="text-blue-600 hover:text-blue-800" title="Lebenslauf">
                                                        <Icon name="tabler:file-text" class="h-4 w-4" />
                                                    </a>
                                                    <a href={`/apply/${r.slug}.pdf`} class="text-gray-400 hover:text-gray-600" title="CV PDF">
                                                        <Icon name="tabler:download" class="h-4 w-4" />
                                                    </a>
                                                    {r.body && r.body.trim().length > 0 && (
                                                        <a href={`/apply/${r.slug}-letter.pdf`} class="text-gray-400 hover:text-gray-600" title="Anschreiben PDF">
                                                            <Icon name="tabler:file-type-doc" class="h-4 w-4" />
                                                        </a>
                                                    )}
                                                    {r.data.jobUrl && (
                                                        <a href={r.data.jobUrl} target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-gray-600" title="Stellenanzeige">
                                                            <Icon name="tabler:external-link" class="h-4 w-4" />
                                                        </a>
                                                    )}
                                                    <a href={buildMailtoUrl(r.data.position, r.data.company, r.slug, r.data.lang, r.data.contactEmail, r.data.contact, r.body, r.data.source, r.data.salutation)} class="text-gray-400 hover:text-gray-600" title={r.data.contactEmail ? `E-Mail an ${r.data.contactEmail}` : "E-Mail verfassen"}>
                                                        <Icon name="tabler:mail" class="h-4 w-4" />
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {history.length > 0 && (
                                            <tr data-detail class="hidden">
                                                <td colspan="8" class="px-4 py-0 bg-gray-50/50">
                                                    <div class="py-3 pl-2">
                                                        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-3">Status-Verlauf</p>
                                                        {history.map((entry, i) => (
                                                            <div class="flex gap-3">
                                                                <div class="flex flex-col items-center">
                                                                    <div class:list={["w-2.5 h-2.5 rounded-full shrink-0 mt-1", statusDotColors[entry.status] || "bg-gray-400"]} />
                                                                    {i < history.length - 1 && <div class="w-px flex-1 bg-gray-200 min-h-4" />}
                                                                </div>
                                                                <div class:list={["min-w-0", i < history.length - 1 ? "pb-3" : ""]}>
                                                                    <div class="flex items-center gap-2">
                                                                        <span class:list={["text-xs font-medium px-2 py-0.5 rounded-full", statusColors[entry.status] || "bg-gray-100 text-gray-700"]}>{statusLabels[entry.status] || entry.status}</span>
                                                                        <span class="text-xs text-gray-400">{formatDate(entry.date)}</span>
                                                                    </div>
                                                                    {entry.info && <p class="text-sm text-gray-600 mt-1 whitespace-pre-line">{entry.info}</p>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </>
                                );
                            })
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <style>
        .search-hidden {
            display: none !important;
        }

        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm 12mm;
            }

            html, body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Hide UI chrome */
            #gate,
            #search-input,
            .sort-btn,
            #lockout-btn,
            #result-count,
            #card-container,
            .expand-icon,
            a[href="/cv-de-print"],
            a[href="/cv-en-print"],
            a[href$=".pdf"],
            a[href$="-letter.pdf"] {
                display: none !important;
            }

            /* Hide the entire toolbar row */
            .flex.items-center.justify-between.mb-6 .flex.items-center.gap-3 {
                display: none !important;
            }

            .flex.flex-col.sm\:flex-row {
                display: none !important;
            }

            #result-count {
                display: none !important;
            }

            /* Show content */
            #content {
                display: block !important;
            }

            #content.hidden {
                display: block !important;
            }

            .min-h-screen {
                min-height: auto !important;
            }

            .bg-gray-100 {
                background: white !important;
            }

            /* Force desktop table visible */
            .hidden.md\:block {
                display: block !important;
            }

            /* Table styles */
            table {
                width: 100%;
                font-size: 8pt;
                border-collapse: collapse;
            }

            thead {
                background: #f3f4f6 !important;
            }

            th {
                font-size: 7pt;
                padding: 4px 6px !important;
                text-align: left;
            }

            td {
                padding: 4px 6px !important;
                vertical-align: top;
            }

            tr[data-expandable] {
                break-inside: avoid;
            }

            /* Show all detail rows (status history) */
            tr[data-detail] {
                display: table-row !important;
            }

            tr[data-detail] td {
                background: #fafafa !important;
                padding-top: 2px !important;
                padding-bottom: 6px !important;
            }

            /* Keep status badges readable */
            span[class*="bg-"] {
                border: 0.5px solid #d1d5db;
            }

            /* Remove shadows, borders, rounded corners */
            .shadow-sm, .shadow-md {
                box-shadow: none !important;
            }

            .rounded-lg {
                border-radius: 0 !important;
            }

            .border-gray-200 {
                border-color: #d1d5db !important;
            }

            /* Links column: hide in print */
            th:last-child,
            td:last-child {
                display: none;
            }

            /* Compact spacing */
            .max-w-7xl {
                max-width: none !important;
                padding: 0 !important;
            }

            .px-6 {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .py-10 {
                padding-top: 4mm !important;
                padding-bottom: 0 !important;
            }

            h1 {
                font-size: 14pt !important;
                margin-bottom: 4mm !important;
            }

            /* Disable hover styles */
            a {
                color: inherit !important;
                text-decoration: none !important;
            }
        }
    </style>

    <script>
        // Password gate – verified server-side via Netlify Function.
        // In dev mode, skip the gate entirely.
        const isDev = import.meta.env.DEV;
        if (isDev || sessionStorage.getItem("apply-auth") === "1") {
            document.getElementById("gate")!.classList.add("hidden");
            document.getElementById("content")!.classList.remove("hidden");
        }

        // --- Expand/Collapse ---
        document.querySelectorAll("tr[data-expandable]").forEach((row) => {
            row.addEventListener("click", (e) => {
                if ((e.target as HTMLElement).closest("a")) return;
                const detail = row.nextElementSibling;
                if (detail?.hasAttribute("data-detail")) {
                    detail.classList.toggle("hidden");
                    row.querySelector(".expand-icon")?.classList.toggle("rotate-180");
                }
            });
        });

        document.querySelectorAll("[data-expandable-card]").forEach((card) => {
            card.addEventListener("click", (e) => {
                if ((e.target as HTMLElement).closest("a")) return;
                const detail = card.querySelector("[data-detail]");
                if (detail) {
                    detail.classList.toggle("hidden");
                    card.querySelector(".expand-icon")?.classList.toggle("rotate-180");
                }
            });
        });

        // --- Sort & Search ---
        const sortLabels: Record<string, string> = { date: "Datum", update: "Update", status: "Status", company: "Firma" };
        const defaultDirs: Record<string, string> = { date: "desc", update: "desc", status: "desc", company: "asc" };
        let currentSort = { key: "date", dir: "desc" };

        function getVal(el: Element, key: string): string | number {
            switch (key) {
                case "date":
                    return el.getAttribute("data-date") || "";
                case "update":
                    return el.getAttribute("data-update") || "";
                case "status":
                    return parseInt(el.getAttribute("data-status-order") || "99");
                case "company":
                    return el.getAttribute("data-company") || "";
                default:
                    return "";
            }
        }

        function performSort() {
            const { key, dir } = currentSort;

            // Desktop table
            const tbody = document.getElementById("table-body");
            if (tbody) {
                const rows = [...tbody.querySelectorAll("tr[data-expandable]")];
                const pairs = rows.map((row) => ({
                    el: row,
                    detail: row.nextElementSibling?.hasAttribute("data-detail") ? row.nextElementSibling : null,
                }));
                pairs.sort((a, b) => {
                    const va = getVal(a.el, key);
                    const vb = getVal(b.el, key);
                    let cmp = va < vb ? -1 : va > vb ? 1 : 0;
                    if (dir === "desc") cmp = -cmp;
                    return cmp;
                });
                pairs.forEach(({ el, detail }) => {
                    tbody.appendChild(el);
                    if (detail) tbody.appendChild(detail);
                });
            }

            // Mobile cards
            const container = document.getElementById("card-container");
            if (container) {
                const cards = [...container.querySelectorAll("[data-expandable-card]")];
                cards.sort((a, b) => {
                    const va = getVal(a, key);
                    const vb = getVal(b, key);
                    let cmp = va < vb ? -1 : va > vb ? 1 : 0;
                    if (dir === "desc") cmp = -cmp;
                    return cmp;
                });
                cards.forEach((card) => container.appendChild(card));
            }

            // Update button states
            document.querySelectorAll(".sort-btn").forEach((btn) => {
                const k = btn.getAttribute("data-sort")!;
                const isActive = k === key;
                if (isActive) {
                    btn.className = "sort-btn border border-gray-800 bg-gray-800 text-white px-2.5 py-1 rounded-full transition-colors cursor-pointer";
                    btn.textContent = `${sortLabels[k]} ${dir === "desc" ? "↓" : "↑"}`;
                } else {
                    btn.className = "sort-btn border border-gray-300 text-gray-600 hover:bg-gray-50 px-2.5 py-1 rounded-full transition-colors cursor-pointer";
                    btn.textContent = sortLabels[k];
                }
            });
        }

        document.querySelectorAll(".sort-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                const key = btn.getAttribute("data-sort")!;
                if (currentSort.key === key) {
                    currentSort.dir = currentSort.dir === "desc" ? "asc" : "desc";
                } else {
                    currentSort = { key, dir: defaultDirs[key] || "desc" };
                }
                performSort();
            });
        });

        function performSearch(query: string) {
            const q = query.toLowerCase().trim();
            let visibleCount = 0;
            const total = document.querySelectorAll("tr[data-expandable]").length;

            // Desktop
            document.querySelectorAll("tr[data-expandable]").forEach((row) => {
                const text = row.getAttribute("data-search") || "";
                const show = !q || text.includes(q);
                row.classList.toggle("search-hidden", !show);
                if (show) visibleCount++;
                const detail = row.nextElementSibling;
                if (detail?.hasAttribute("data-detail")) {
                    if (!show) detail.classList.add("search-hidden");
                    else detail.classList.remove("search-hidden");
                }
            });

            // Mobile
            document.querySelectorAll("[data-expandable-card]").forEach((card) => {
                const text = card.getAttribute("data-search") || "";
                const show = !q || text.includes(q);
                card.classList.toggle("search-hidden", !show);
            });

            // Update count
            const countEl = document.getElementById("result-count");
            if (countEl) {
                countEl.textContent = q ? `${visibleCount} von ${total} Bewerbung(en)` : `${total} Bewerbung(en) gespeichert.`;
            }
        }

        document.getElementById("search-input")?.addEventListener("input", (e) => {
            performSearch((e.target as HTMLInputElement).value);
        });

        // --- Lockout ---
        document.getElementById("lockout-btn")?.addEventListener("click", () => {
            sessionStorage.removeItem("apply-auth");
            document.getElementById("content")!.classList.add("hidden");
            document.getElementById("gate")!.classList.remove("hidden");
        });

        // --- Print: expand all status histories ---
        window.addEventListener("beforeprint", () => {
            document.querySelectorAll("tr[data-detail]").forEach((el) => el.classList.remove("hidden"));
            document.querySelectorAll(".expand-icon").forEach((el) => el.classList.add("rotate-180"));
        });
        window.addEventListener("afterprint", () => {
            document.querySelectorAll("tr[data-detail]").forEach((el) => el.classList.add("hidden"));
            document.querySelectorAll(".expand-icon").forEach((el) => el.classList.remove("rotate-180"));
        });

        // --- Password gate ---
        document.getElementById("pw-form")!.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = document.getElementById("pw-input") as HTMLInputElement;
            try {
                const res = await fetch("/.netlify/functions/check-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password: input.value }),
                });
                const data = await res.json();
                if (data.ok) {
                    sessionStorage.setItem("apply-auth", "1");
                    document.getElementById("gate")!.classList.add("hidden");
                    document.getElementById("content")!.classList.remove("hidden");
                } else {
                    document.getElementById("pw-error")!.classList.remove("hidden");
                    input.value = "";
                    input.focus();
                }
            } catch {
                document.getElementById("pw-error")!.classList.remove("hidden");
                input.value = "";
                input.focus();
            }
        });
    </script>
</ResumeLayout>
